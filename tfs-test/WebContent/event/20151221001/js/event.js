//키워드/성분
var keywordArr = {};
keywordArr['건조'] = [];
keywordArr['건조'].push({
	number: 1,
	productURL: '건조',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 건조 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 건조 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 건조 카톡'
});
keywordArr['푸석'] = [];
keywordArr['푸석'].push({
	number: 1,
	productURL: '푸석',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 푸석 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 푸석 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 푸석 카톡'
});
keywordArr['유분'] = [];
keywordArr['유분'].push({
	number: 2,
	productURL: '유분',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 유분 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 유분 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 유분 카톡'
});
keywordArr['칙칙'] = [];
keywordArr['칙칙'].push({
	number: 2,
	productURL: '칙칙',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 칙칙 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 칙칙 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 칙칙 카톡'
});
keywordArr['피지'] = [];
keywordArr['피지'].push({
	number: 3,
	productURL: '피지',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 피지 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 피지 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 피지 카톡'
});
keywordArr['모공'] = [];
keywordArr['모공'].push({
	number: 3,
	productURL: '모공',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 모공 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 모공 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 모공 카톡'
});
keywordArr['흔적'] = [];
keywordArr['흔적'].push({
	number: 4,
	productURL: '흔적',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 흔적 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 흔적 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 흔적 카톡'
});
keywordArr['자국'] = [];
keywordArr['자국'].push({
	number: 4,
	productURL: '자국',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 자국 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 자국 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 자국 카톡'
});
keywordArr['민감'] = [];
keywordArr['민감'].push({
	number: 5,
	productURL: '민감',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 민감 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 민감 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 민감 카톡'
});
keywordArr['예민'] = [];
keywordArr['예민'].push({
	number: 5,
	productURL: '예민',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 예민 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 예민 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 예민 카톡'
});
keywordArr['주름'] = [];
keywordArr['주름'].push({
	number: 6,
	productURL: '주름',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 주름 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 주름 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 주름 카톡'
});
keywordArr['탄력저하'] = [];
keywordArr['탄력저하'].push({
	number: 6,
	productURL: '탄력저하',
	facebook: '더페이스샵 리뉴얼 이벤트 테스트 탄력저하 페이스북',
	kakaostory: '더페이스샵 리뉴얼 이벤트 테스트 탄력저하 카스',
	kakaostoryImg: '/BCPcw/hyhqjnTcds/OTXdraZ7kxThzmOXDkFNmk/img.jpg?width=632&height=316',
	kakaotalk: '더페이스샵 리뉴얼 이벤트 테스트 탄력저하 카톡'
});

function RenewalEventViewModel() {
	var self = this;
    self.isLoading = ko.observable(false);
	self.worryType = ko.observable();
	self.resultNumber = ko.observable();
	self.resultProductDetailURL = ko.observable();

	self.selectWorry = function(worryType) {
		self.worryType(worryType);
		self.resultNumber(keywordArr[worryType][0].number);
		self.resultProductDetailURL(keywordArr[worryType][0].productURL);

		closePop('pop_drag');
		openPop('pop_entry');		
	}

	self.successEntry = function (data) {
        alert('개인정보가 등록되었습니다. 감사합니다^^');
		closePop('pop_entry');
		openPop('pop_result');
    }
    self.failureEntry = function (data) {
        alert(data.message);
    }

	//SNS 공유
    self.shareOnSnsComplete = function (snsType, snsUserId, snsUserName, snsScrapURL) {
		var url = '/event/20151221001/sharing.jsp';
		if (location.href == 'www.thefaceshop.com') {
			url = 'https://' + location.href + ':343/event/20151221001/entry.jsp';
		}
        $.ajax({
            url: url,
            type: 'post',
            data: {
                sns: snsType,
                snsId: snsUserId,
                snsName: snsUserName,
                scrapURL: snsScrapURL,
            },
            success: function () {
                alert('공유가 완료되었습니다\r\n다른 SNS로도 공유하시면 당첨확률이 높아집니다!^^');
            },
            error: function (req) {
                alert(req.responseJSON.message);
            }
        });
    }
    self.shareOnSns = function (data, event) {
        var $this = $(event.target);
        var snsType = $this.data('snsType');
        switch (snsType) {
            case 'facebook': {
                setTimeout(function () {
                    self.isLoading(true);
                    $('.loading').show();
                }, 500);

                var metaViewportContent = $('meta[name=viewport]').attr('content');
                var data = {};
                data.link = 'http://www.thefaceshop.com/event/20151221001/event.jsp';
                data.picture = 'http://www.thefaceshop.com/event/20151221001/images/thumbnail/facebook_' + self.worryType + '.png';
                data.name = '더페이스샵 테라피를 부탁해';
                data.description = keywordArr[self.worryType()][0].facebook;
                facebookShare(data, function (userId, userName, postId) {
					var scrapURL = postId;
                    self.shareOnSnsComplete(snsType, userId, userName, scrapURL);
                    if (isMobile.Android()) {
                        $('meta[name=viewport]').attr('content', metaViewportContent);
                    }
                }, function (error) {
                    self.isLoading(false);
                    $('.loading').hide();
                    alert('공유하셔야 참여가 완료됩니다');
                    if (isMobile.Android()) {
                        $('meta[name=viewport]').attr('content', metaViewportContent);
                    }
                });
                break;
            }
           case 'kakaostory': {                
				var data = {};
				data.picture = keywordArr[self.worryType()][0].kakaostoryImg;
				data.content = keywordArr[self.worryType()][0].kakaostory;
				kakaostoryShareImage(data, function (userId, userName, postId) {
					var scrapURL = 'https://story.kakao.com/' + postId.replace('.', '/');
					self.shareOnSnsComplete(snsType, userId, userName, scrapURL);
				}, function (error) {
					var data = JSON.parse(error);
					if (data.error == 'access_denied') {
						alert('로그인 정보 동의 후 참여 가능합니다');
					} else {
						alert(data.error_description);
					}
				});                
                break;
            }
            case 'kakaotalk': {
                if (isMobile.any()) {
                    alert('공유 후 다시 브라우저로 돌아오셔야 공유가 완료됩니다!^^');
                }
                var data = {};
                data.label = keywordArr[self.worryType()][0].kakaotalk;
                data.btnText = '지금 신청하기';
                data.link = 'http://www.thefaceshop.com/event/20151221001/event.jsp';
                data.image = 'http://www.thefaceshop.com/event/20151221001/images/thumbnail/kakaotalk_' + self.week + '.png';
                data.imageW = 300;
                data.imageH = 200;
                kakaotalkShare(data, function () {
                    self.shareOnSnsComplete(snsType, null, null, null);
                }, function (error) {
                    alert("카카오톡 설치 가능한 모바일기기에서만 사용 가능합니다.");
                });
                break;
            }
            default: {
                self.isLoading(false);
                $('.loading').hide();
                break;
            }
        }
    }
}

$(function() {
	Kakao.init('31bc67cd2a8c38768707245d3a0d4a75');

	$('.draggable').draggable({
		containment: '#dragArea'
	});
	$('#basket').droppable({
		drop: function( event, ui ) {
			$('.draggable').draggable('disable');

			var obj = ui.draggable.context.id;			
			$('#' + obj).hide();

			var worryType = $('#' + obj).attr('data-name');
			viewModel.selectWorry(worryType);
		}
	});

	$('#frm').validate({
		rules: {
			name: {
				required: true
			},
			mobile: {
				required: true,
				digits: true,
				rangelength: [10,11]
			},
			zipcode: {
				required: true
			},
			address1: {
				required: true
			},
			address2: {
				required: true
			},
			agree1: {
				required: true,
				minlength: function(e) {
					return $('#chkbox_agree1').is(':checked') ? 0 : 100;
				}
			},
			agree2: {
				required: true,
				minlength: function(e) {
					return $('#chkbox_agree2').is(':checked') ? 0 : 100;
				}
			}
		},
		messages: {
			name: {
				required: '이름을 입력해 주세요.'
			},
			mobile: {
				required: '연락처를 입력해 주세요.',
				digits: '연락처를 정확히 입력해 주세요.',
				rangelength: '연락처를 정확히 입력해 주세요.'
			},
			zipcode: {
				required: '주소를 검색해주세요'
			},
			address1: {
				required: '주소를 검색해주세요'
			},
			address2: {
				required: '나머지 주소를 입력해주세요'
			},
			agree1: {
				required: '개인정보의 수집/이용에 동의해 주세요.',
				minlength: '개인정보의 수집/이용에 동의해 주세요.'
			},
			agree2: {
				required: '개인정보의 취급 위탁에 동의해 주세요.',
				minlength: '개인정보의 취급 위탁에 동의해 주세요.'
			}
		},
		showErrors: function(errorMap, errorList) {
			for(var i in errorMap) {
				alert(errorMap[i]);
				break;
			}
		},
		onfocusout: false,
		onkeyup: false,
		onclick: false,
		submitHandler: function(form) {
			var mobile = $('#mobile').val();
			var regexMobile = new RegExp(/^(010|011|016|017|018|019)[0-9]{7,8}$/); 			
			if (!regexMobile.test(mobile)){
				alert('연락처를 확인해주세요');
				$('#mobile').focus();
				$('.loading_auth').hide();
				return;
			}

			$.ajax({
				type : 'post',
				url : $('#frm').attr('action'),
				cache : false,
				data : $('#frm').serialize(),
				success : viewModel.successEntry,
				error : viewModel.failureEntry
			});
		}
	});
	
	//제품 등록 우편번호
	$('#openFindzip').on('click', function (e) {
		e.preventDefault();
		if (isMobile.any()) {
			findzipShow();
			/*
			setTimeout(function () {
				var id = $(document).find('iframe').parent().attr('id');
				$('#' + id).css('margin', '0 auto');
			}, 500);
			*/
			var currentScroll = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
			new daum.Postcode({
				oncomplete: function (data) {
					findzipHide();

					// 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

					// 각 주소의 노출 규칙에 따라 주소를 조합한다.
					// 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
					var fullAddr = data.address; // 최종 주소 변수
					var extraAddr = ''; // 조합형 주소 변수

					// 기본 주소가 도로명 타입일때 조합한다.
					if(data.addressType === 'R'){
						//법정동명이 있을 경우 추가한다.
						if(data.bname !== ''){
							extraAddr += data.bname;
						}
						// 건물명이 있을 경우 추가한다.
						if(data.buildingName !== ''){
							extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
						}
						// 조합형주소의 유무에 따라 양쪽에 괄호를 추가하여 최종 주소를 만든다.
						fullAddr += (extraAddr !== '' ? ' ('+ extraAddr +')' : '');
					}

					// 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.
					// 우편번호와 주소 및 영문주소 정보를 해당 필드에 넣는다.
					var form = $('#frm');
					form.find('input[name=addressType]').val(data.addressType); //R(도로명), J(지번)
					form.find('input[name=zipcode]').val(data.zonecode);
					form.find('input[name=address1]').val(fullAddr);
					form.find('input[name=address2]').focus();

					document.body.scrollTop = currentScroll;
				},
				width: '640',
				height: '3969'
			}).embed(document.getElementById('popZip'));
		} else {
			new daum.Postcode({
				oncomplete: function (data) {
					// 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

					// 각 주소의 노출 규칙에 따라 주소를 조합한다.
					// 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
					var fullAddr = ''; // 최종 주소 변수
					var extraAddr = ''; // 조합형 주소 변수

					// 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
					if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
						fullAddr = data.roadAddress;

					} else { // 사용자가 지번 주소를 선택했을 경우(J)
						fullAddr = data.jibunAddress;
					}

					// 사용자가 선택한 주소가 도로명 타입일때 조합한다.
					if(data.userSelectedType === 'R'){
						//법정동명이 있을 경우 추가한다.
						if(data.bname !== ''){
							extraAddr += data.bname;
						}
						// 건물명이 있을 경우 추가한다.
						if(data.buildingName !== ''){
							extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
						}
						// 조합형주소의 유무에 따라 양쪽에 괄호를 추가하여 최종 주소를 만든다.
						fullAddr += (extraAddr !== '' ? ' ('+ extraAddr +')' : '');
					}

					var form = $('#frm');
					form.find('input[name=addressType]').val(data.userSelectedType); //R(도로명), J(지번)
					form.find('input[name=zipcode]').val(data.zonecode);
					form.find('input[name=address1]').val(fullAddr);
					form.find('input[name=address2]').focus();
				}
			}).open();		            
		}
	});
});